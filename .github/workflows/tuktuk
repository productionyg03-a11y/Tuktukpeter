<!doctype html>
<html lang='th'>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>TukTuk Turbo Crash v3 — RTP Tuned</title>
<style>
  :root{--bg:#070b13;--p:#22d3ee;--danger:#fb7185;--txt:#e5e7eb}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{position:relative;width:100%;height:100%}
  .ui{position:absolute;inset:0;display:flex;flex-direction:column;pointer-events:none}
  .top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px}
  .mult{font-weight:900;font-size:32px;text-shadow:0 4px 18px rgba(34,211,238,.2)}
  .mid{display:flex;justify-content:center}.status{font-weight:700;font-size:13px;color:#c7d2fe;padding:4px 10px;border-radius:999px;background:rgba(99,102,241,.12);border:1px solid rgba(99,102,241,.2)}
  .panel{pointer-events:auto;margin-top:auto;padding:12px;display:grid;gap:10px;background:linear-gradient(0deg,rgba(0,0,0,.25),rgba(0,0,0,0))}
  .row{display:flex;gap:8px;align-items:center}
  .input{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
  .input input{width:100%;background:transparent;color:var(--txt);border:0;outline:0;font-weight:700}
  .ghost{padding:8px 10px;font-size:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#cbd5e1;cursor:pointer}
  .cta{width:100%;padding:14px 16px;font-weight:900;border-radius:16px;border:1px solid rgba(255,255,255,.18);background:var(--p);color:#07121a;box-shadow:0 12px 26px rgba(34,211,238,.28),inset 0 -2px 0 rgba(0,0,0,.25);cursor:pointer}
  .row2{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  .note{font-size:11px;color:#93c5fd;text-align:center;opacity:.85}
  .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:120px;background:rgba(2,6,23,.9);border:1px solid rgba(255,255,255,.1);padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);font-weight:700}
</style>
<body>
<div class='wrap'>
  <canvas id='c' style='display:block;width:100%;height:100%'></canvas>
  <div class='ui'>
    <div class='top'><div class='badge'>TukTuk Turbo Crash v3</div><div class='mult' id='m'>1.00x</div></div>
    <div class='mid'><div class='status' id='s'>พร้อมเริ่ม</div></div>
    <div class='panel'>
      <div class='row'>
        <div class='input'><span style='opacity:.7'>เดิมพัน</span><input id='bet' type='number' min='10' step='1' value='10'>
          <button class='ghost' id='x2'>+2x</button><button class='ghost' id='x05'>½</button></div>
        <div class='badge' id='edge'>ค่าน้ำ 2%</div>
      </div>
      <div class='row2'>
        <button class='cta' id='cta'>ขึ้นรถ</button>
        <button class='ghost' id='turbo'>Turbo</button>
        <button class='ghost' id='restart'>เริ่มใหม่</button>
      </div>
      <div class='note'>Mini-RTP: Cashback • Streak Bonus • Bonus Chest • Adaptive Lambda</div>
    </div>
  </div>
  <div id='toast' class='toast' style='display:none'></div>
</div>
<script>
  const $=s=>document.querySelector(s);const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const rnd=(()=>{let t=(Date.now()^0xabcddcba)&0xffffffff;return()=>{t+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}})();
  const exp=lambda=>-Math.log(1-Math.min(.999999,Math.max(.000001,rnd())))/lambda;
  const toast=(msg)=>{const el=$('#toast');el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',1500)};

  const ECON = {
    houseFee: 0.02,
    cashbackBase: 0.02,
    cashbackMax: 0.08,
    streakStep: 0.02,
    streakCap: 0.10,
    bonusChestChance: 0.08,
    bonusChestEV: 0.015,
    lambdaBase: 0.95,
    lambdaEasy: 0.80,
    easyAfter: 3
  };
  $('#edge').textContent = 'ค่าน้ำ '+(ECON.houseFee*100).toFixed(0)+'%';

  let bet=10, mult=1, bustAt=0, state='idle', last=0, acc=0, dt=1000/60, turbo=false;
  let lossStreak=0, winStreak=0;
  const canvas=$('#c'), ctx=canvas.getContext('2d'); const m=$('#m'), s=$('#s'), cta=$('#cta');

  $('#bet').oninput=()=>bet=Math.max(10, +$('#bet').value||10);
  $('#x2').onclick=()=>{$('#bet').value=bet=Math.round(bet*2)};
  $('#x05').onclick=()=>{$('#bet').value=bet=Math.max(10,Math.floor(bet/2))};
  $('#restart').onclick=()=>reset(true);
  $('#turbo').onclick=()=>turbo=!turbo;
  cta.onclick=()=>{if(state==='idle')start();else if(state==='running')cashout();else reset(true)};
  addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();cta.click()} if((e.key||'').toLowerCase()==='r')reset(true)});

  function start(){
    state='running';mult=1;
    const lambda = (lossStreak >= ECON.easyAfter) ? ECON.lambdaEasy : ECON.lambdaBase;
    bustAt = 1 + exp(lambda);
    s.textContent='กำลังวิ่ง... กดเพื่อ ลงรถ'; cta.textContent='ลงรถ'; post({type:'BET',amount:bet});
  }
  function cashout(){
    if(state!=='running')return; state='cashout';
    const streakBonus = clamp(winStreak*ECON.streakStep, 0, ECON.streakCap);
    const payout = Math.max(0, bet * mult * (1 - ECON.houseFee) * (1 + streakBonus));
    s.textContent = `รับเงินแล้ว ${payout.toFixed(2)} THB @ ${mult.toFixed(2)}x (+${(streakBonus*100).toFixed(0)}% สตรีค)`;
    cta.textContent='เริ่มรอบใหม่'; winStreak++; lossStreak = 0;
    post({type:'RESULT',win:true,payout, mult, winStreak});
    bonusChest();
  }
  function bust(){
    state='bust';
    const cbRate = clamp(ECON.cashbackBase + (lossStreak*0.02), ECON.cashbackBase, ECON.cashbackMax);
    const cashback = bet * cbRate;
    s.textContent = `รถคว่ำ! ได้คืน ${cashback.toFixed(2)} THB`;
    cta.textContent='เริ่มรอบใหม่';
    post({type:'RESULT',win:false,payout:cashback, mult, lossStreak});
    winStreak = 0; lossStreak++;
    toast('Cashback +' + (cbRate*100).toFixed(0) + '%');
    bonusChest();
  }
  function reset(){state='idle';mult=1;bustAt=0;s.textContent='พร้อมเริ่ม';cta.textContent='ขึ้นรถ'}
  function post(msg){try{parent.postMessage(msg,'*')}catch(e){}}

  function bonusChest(){
    if(rnd() < ECON.bonusChestChance){
      const high = 0.15, low = 0.005;
      const EV = ECON.bonusChestEV;
      const p = Math.max(0, Math.min(1,(EV - low)/(high - low)));
      const reward = bet * (rnd() < p ? high : low);
      toast('โบนัสลับ +' + reward.toFixed(2)+' THB');
      post({type:'BONUS', amount: reward});
    }
  }

  function resize(){const r=canvas.getBoundingClientRect();const dpr=Math.min(2,devicePixelRatio||1);canvas.width=r.width*dpr;canvas.height=r.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0)}
  new ResizeObserver(resize).observe(canvas);resize();

  function update(){
    if(state==='running'){
      const k = turbo ? .56 : .34;
      mult += (dt/1000) * Math.max(0.18, mult * k);
      if(mult >= bustAt) bust();
    }
  }
  function draw(){
    const w=canvas.width/(devicePixelRatio||1), h=canvas.height/(devicePixelRatio||1);
    const g=ctx.createLinearGradient(0,0,0,h);g.addColorStop(0,'#0c1426');g.addColorStop(1,'#0a0f1e');ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
    ctx.save();for(let l=0;l<3;l++){const a=[.15,.22,.3][l], base=h*(.58+l*.03);ctx.globalAlpha=a;
      for(let i=0;i<18;i++){const bw=12+(i*7%26), bh=30+((i*13+l*37)%90), bx=(i/18)*w + (performance.now()/(12000-l*2500))%w;
        ctx.fillStyle=`hsl(${218+l*6},18%,${22+l*5}%)`;ctx.fillRect(bx%w,base-bh,bw,bh);}}ctx.restore();
    const road=h*.7;ctx.fillStyle='#0c0f18';ctx.fillRect(0,road,w,h-road);ctx.setLineDash([12,12]);ctx.lineWidth=3;ctx.strokeStyle='rgba(255,255,255,.14)';
    ctx.beginPath();ctx.moveTo(0,road+24);ctx.lineTo(w,road+24);ctx.stroke();ctx.setLineDash([]);
    const t=Math.max(0,Math.min(1,(mult-1)/3)), x=16+(w-140)*t, y=road-28;
    ctx.fillStyle='#0ea5e9';ctx.fillRect(x,y-22,100,24);
    ctx.fillStyle='#111827';ctx.beginPath();ctx.arc(x+18,y+2,10,0,7);ctx.fill();
    ctx.beginPath();ctx.arc(x+78,y+2,10,0,7);ctx.fill();
    ctx.fillStyle='#22d3ee';ctx.fillRect(x+18,y-44,66,20);
    ctx.fillStyle='#67e8f9';ctx.fillRect(x+20,y-42,62,16);
    if(state==='running'){const bx=16+(w-140)*Math.max(0,Math.min(1,(bustAt-1)/3));ctx.strokeStyle='#fb7185';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(bx,road-60);ctx.lineTo(bx,road+8);ctx.stroke()}
    m.textContent=mult.toFixed(2)+'x';
  }
  function loop(t){if(!last)last=t;const frame=Math.min(250,t-last);last=t;acc+=frame;while(acc>=dt){update();acc-=dt}draw();requestAnimationFrame(loop)}
  requestAnimationFrame(loop);
</script>
</html>
